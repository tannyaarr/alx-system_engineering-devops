#!/usr/bin/env bash
# Install and configure HAproxy on lb-01 server

sudo apt-get update
sudo apt-get upgrade -y
sudo apt-get install -y haproxy

cat << EOL | sudo tee /etc/haproxy/haproxy.cfg
global
	log /dev/log local0
	log /dev/log local1 notice
	chroot /var/lib/haproxy
	stats socket /run/haproxy/admin.sock mode 600 level admin expose-fd listeners
	stats timeout 30s
	user haproxy
	group haproxy
	daemon

defaults
	log global
	mode http
	option httplog
	option dontlognull
	timeout conect 5000
	timeout client 50000
	timeout server 50000

frontend myfrontend
	bind *:80
	stats uri /haproxy?stats
	default_backend mybackend

backend mybackend
	balance roundrobin
	server web-01 100.25.179.193:80 check
	server web-02 52.86.33.156:80 check
EOL

sudo systemctl enable haproxy
sudo systemctl start haproxy
