#!/usr/bin/env bash
# Install and configure HAproxy on lb-01 server

sudo apt-get update
sudo apt-get install -y haproxy

sudo cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak

cat << EOT | sudo tee /etc/haproxy/haproxy.cfg
global
	log /dev/log local0
	log /dev/log local1 notice
	user haproxy
	group haproxy

defaults
	log global
	mode http
	option httplog
	option dontlognull
	retries 3
	option redispatch
	maxconn 2000
	timeout conect 5s
	timeout client 50s
	timeout server 50s

frontend http_front
	bind *:80
	stats uri /haproxy?stats
	default_backend http_back

backend http_back
	balance roundrobin
	server 254410-web-01 100.25.179.193:80 check
	server 254410-web-02 52.86.33.156:80 check
EOT

sudo systemctl enable haproxy
sudo systemctl start haproxy
